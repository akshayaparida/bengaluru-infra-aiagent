# Twitter Rate Limit Issue - Diagnosis & Fix

## Issue Reported
User reported: "ai tweet not working, only email showing in UI"

## Root Cause
**Twitter API Rate Limit (HTTP 429)**

### Diagnosis Evidence
```bash
# Database check shows:
emailedAt: ✅ 2025-10-03 21:29:58 (Working)
tweetedAt: ❌ NULL (Not being set)
tweetId: ❌ NULL (No tweet ID stored)

# API test shows:
POST /api/reports/{id}/tweet
Response: {"ok": false, "reason": "twitter_post_failed", "detail": "429"}
```

### What's Happening
1. ✅ Report submitted successfully
2. ✅ Email sent (via SMTP, no rate limits)
3. ✅ Tweet text generated by AI (MCP Gateway working)
4. ❌ **Twitter API rejects with 429** (rate limit exceeded)
5. ❌ `tweetedAt` never gets set in database
6. ❌ UI doesn't show "Tweeted ✓" badge

## Twitter API Rate Limits

### Free Tier
- **Read**: 10,000 requests/month
- **Write (Tweets)**: ~50 tweets/month
- **Time Window**: Rolling 24-hour period

### Basic Tier ($100/month)
- **Read**: 10,000 requests/month  
- **Write**: ~3,000 tweets/month
- **Post tweets**: 3,000/month

### Common Causes
1. **Testing**: Multiple test tweets during development
2. **Auto-tweet enabled**: Every report submission triggers a tweet
3. **No cooldown**: Back-to-back submissions hit limit quickly

## Solutions

### Immediate Fix: Enable Simulation Mode

**File:** `.env`
```bash
# Change this:
SIMULATE_TWITTER=false

# To this (for testing):
SIMULATE_TWITTER=true
```

**What this does:**
- ✅ Generates AI tweet text (tests MCP Gateway)
- ✅ Shows "Tweeted ✓ (simulated)" in UI
- ✅ Stores `tweetedAt` and `tweetId` (simulated)
- ❌ Does NOT post to actual Twitter (saves rate limit)
- ✅ Perfect for development/testing

### Better Error Handling (Code Fix)

The current code catches the 429 error but doesn't handle it gracefully. Let's add better logging and retry logic.

**Current behavior:**
```typescript
// Line 154-156 in tweet/route.ts
catch (err: any) {
  return NextResponse.json({ 
    ok: false, 
    reason: 'twitter_post_failed', 
    detail: String(err?.code || err?.message || 'error') 
  }, { status: 502 });
}
```

**Issues:**
1. Silent failure - doesn't log rate limit
2. Generic 502 error
3. No guidance for user

**Recommended Fix:**
```typescript
catch (err: any) {
  const errorCode = String(err?.code || err?.message || 'unknown');
  
  // Specific handling for rate limit
  if (errorCode === '429' || errorCode.includes('rate limit')) {
    console.error('[Twitter] Rate limit exceeded. Consider upgrading API tier or enabling SIMULATE_TWITTER');
    return NextResponse.json({ 
      ok: false, 
      reason: 'rate_limit_exceeded', 
      detail: 'Twitter API rate limit reached. Please try again later or upgrade API tier.',
      retryAfter: err?.rateLimit?.reset // Twitter provides this
    }, { status: 429 });
  }
  
  console.error('[Twitter] Post failed:', errorCode);
  return NextResponse.json({ 
    ok: false, 
    reason: 'twitter_post_failed', 
    detail: errorCode
  }, { status: 502 });
}
```

### Production Strategy

#### Option 1: Rate Limit Management
```bash
# Add to .env
TWEET_COOLDOWN_SECONDS=300  # 5 minutes between tweets
MAX_TWEETS_PER_HOUR=10      # Safety limit
```

#### Option 2: Queue System
- Store tweets in queue
- Process with delay (avoid bursts)
- Respect rate limits automatically

#### Option 3: Upgrade Twitter API Tier
- **Basic**: $100/month → 3,000 tweets/month
- **Pro**: $5,000/month → 10,000 tweets/month
- **Enterprise**: Custom pricing

## Verification Steps

### Step 1: Check Current Rate Limit Status
```bash
# Twitter API doesn't expose rate limit checking easily
# Best way: Check Twitter Developer Portal
https://developer.twitter.com/en/portal/dashboard
```

### Step 2: Enable Simulation Mode
```bash
cd /home/akshayaparida/bengaluru-infra-aiagent
echo "SIMULATE_TWITTER=true" >> .env

# Restart Next.js server
pkill -f "next dev"
pnpm dev
```

### Step 3: Test Report Submission
1. Go to http://localhost:3000
2. Submit a test report
3. Check UI - should show "Tweeted ✓ (simulated)"
4. Check database:
```sql
SELECT id, description, "tweetedAt", "tweetId" 
FROM "Report" 
ORDER BY "createdAt" DESC 
LIMIT 1;
```

Expected output:
```
tweetedAt: 2025-10-03 21:40:00  ✅
tweetId: sim-1735939200000    ✅ (simulated ID)
```

### Step 4: Wait 24 Hours & Re-test Real Tweets
```bash
# After 24 hours, rate limit resets
# Re-enable real tweeting:
echo "SIMULATE_TWITTER=false" >> .env

# Test one real tweet
curl -X POST http://localhost:3000/api/reports/{id}/tweet
```

## Why This Happens

### Development vs Production
- **Development**: Frequent testing → Hit rate limit quickly
- **Production**: Real usage → Spread out naturally

### AUTO_TWEET Flag
```bash
# Current setting:
AUTO_TWEET=true  # Every report → instant tweet

# Consider:
AUTO_TWEET=false  # Manual tweet button only
```

This lets you:
- Review reports before tweeting
- Avoid accidental rate limit hits
- Control tweet timing

## UI Display Issue

The UI shows "Tweeted ✓" only when:
```typescript
// DashboardView.tsx Line 167-173
{r.tweetedAt && (
  (r.tweetId && !r.tweetId.startsWith('sim-')) ? (
    <a href={`https://x.com/i/web/status/${r.tweetId}`}>Tweeted ✓ (view)</a>
  ) : (
    <span>Tweeted ✓ (simulated)</span>
  )
)}
```

**Current state:** `tweetedAt` is NULL → UI shows nothing

**After fix:** `tweetedAt` will be set → UI shows "Tweeted ✓"

## Testing Without Rate Limits

### Use Simulation Mode
```bash
SIMULATE_TWITTER=true
```

Benefits:
- ✅ Tests entire flow
- ✅ Tests AI generation
- ✅ Tests database updates
- ✅ Tests UI display
- ❌ Doesn't test actual Twitter posting

### Mock Twitter Client (Advanced)
For unit tests, mock the TwitterApi:
```typescript
// In tests
jest.mock('twitter-api-v2', () => ({
  TwitterApi: jest.fn().mockImplementation(() => ({
    v2: {
      tweet: jest.fn().mockResolvedValue({ 
        data: { id: 'test-tweet-id' } 
      })
    },
    v1: {
      uploadMedia: jest.fn().mockResolvedValue('test-media-id')
    }
  }))
}));
```

## Rate Limit Best Practices

### 1. Implement Cooldown
```typescript
// Check last tweet time before posting
const lastTweet = await prisma.report.findFirst({
  where: { tweetedAt: { not: null } },
  orderBy: { tweetedAt: 'desc' }
});

const cooldownMs = 5 * 60 * 1000; // 5 minutes
if (lastTweet && Date.now() - lastTweet.tweetedAt.getTime() < cooldownMs) {
  return NextResponse.json({ 
    ok: false, 
    reason: 'cooldown_active',
    retryAfter: Math.ceil((lastTweet.tweetedAt.getTime() + cooldownMs - Date.now()) / 1000)
  }, { status: 429 });
}
```

### 2. Track Rate Limit in App
```typescript
// Store rate limit info from Twitter response
interface RateLimitInfo {
  limit: number;
  remaining: number;
  reset: number; // Unix timestamp
}

// Twitter returns this in headers
const rateLimit: RateLimitInfo = {
  limit: parseInt(response.headers['x-rate-limit-limit'] || '0'),
  remaining: parseInt(response.headers['x-rate-limit-remaining'] || '0'),
  reset: parseInt(response.headers['x-rate-limit-reset'] || '0')
};
```

### 3. Queue System
```typescript
// Use Bull or similar queue
import { Queue } from 'bull';
const tweetQueue = new Queue('tweets');

// Add to queue instead of immediate post
await tweetQueue.add({ reportId: id }, {
  delay: 60000, // 1 minute delay
  attempts: 3,
  backoff: { type: 'exponential', delay: 60000 }
});
```

## Commit Message Template

```
fix: Handle Twitter rate limit (429) gracefully

- Add specific error handling for HTTP 429 responses
- Log rate limit errors with actionable guidance
- Return proper 429 status instead of generic 502
- Include retry-after information from Twitter
- Document simulation mode for development testing

Fixes: Tweet endpoint failing silently with rate limits
Context: Twitter Free/Basic tier has strict posting limits
Testing: Enable SIMULATE_TWITTER=true for development
```

## Interview/Production Context

### Why Rate Limits Exist
1. **Spam Prevention**: Limit bot abuse
2. **Resource Management**: Fair API usage
3. **Revenue Model**: Incentivize paid tiers

### Production Considerations
1. **Cost**: $100/month for Basic tier
2. **Architecture**: Queue system for reliability
3. **Monitoring**: Track rate limit usage
4. **Fallback**: Simulation mode when limit hit

### What to Tell Users
- **Development**: "Using simulation mode to avoid rate limits"
- **Production**: "Tweets queued, will post when rate limit available"
- **Error**: "Twitter rate limit reached, please try again in X minutes"

---

**Current Status:** ❌ Rate limit exceeded (429)  
**Quick Fix:** Set `SIMULATE_TWITTER=true` in `.env`  
**Long-term:** Implement queue + upgrade Twitter tier  
**Date:** 2025-01-03  
