# Bengaluru Infra AI Agent — POC Reference

Last updated: 2025-09-29
Status: Active
Scope: Local POC only (no deployment)

1) Purpose — why this exists
- Provide a working local demo to report Bengaluru infra issues with GPS + photo, classify with AI, notify via email, optionally simulate a tweet, and visualize on a Leaflet map.
- Centralize scope, architecture, APIs, environment, and runbook so work stays aligned and fast for hackathon timelines.

2) Scope — what we will build (local-only)
- Reporter UI: browser geolocation + photo upload; anonymous submission.
- Notifications: email via Mailpit; AI-crafted subject/body; optional X/Twitter autopost via MCP Gateway with simulation fallback; basic mentions feed (mock OK).
- Dashboard: Leaflet map of reports; transparency panel with budget/department/contractor seeded demo data; AI-generated site/social post for transparency.

Constraints
- Sponsor tech: Cerebras LLaMA API + Docker MCP Gateway.
- Localhost only for demo; do not deploy.
- pnpm, strict TypeScript, TDD-first.
- No secrets in git; use .env.example and .env.local (gitignored).

3) Tech stack
- Frontend: Next.js 15, React 19, TypeScript (strict), Leaflet.
- Backend: Next.js route handlers, Zod for validation.
- DB: Postgres 17.5 (docker-compose) with Prisma ORM.
- Email: Mailpit (SMTP + Web UI) from docker-compose.
- AI + social: MCP Docker Gateway exposing Cerebras LLaMA and social tools (simulation allowed).
- Testing: Vitest (unit/integration), Playwright (E2E), MSW for mocks as needed.
- Logging: Pino.

4) Architecture (high level)
- User submits issue (description, GPS, photo) → API validates (Zod), stores file locally, persists Report row in Postgres.
- Optional async classification (Cerebras via MCP); enriches Report with category/severity.
- Email notification (Mailpit) generated by AI prompt; optional tweet simulation via MCP; both feature-flagged.
- Dashboard reads from GET /api/reports and renders on Leaflet with filters; transparency panel uses seeded budget/contractor data.

5) Data model (minimum viable)
- Report
  - id (string/uuid)
  - createdAt (Date)
  - description (text)
  - lat (float)
  - lng (float)
  - photoPath (string) — local disk path under FILE_STORAGE_DIR
  - status (enum: new, triaged, notified) — start as "new"
  - category (string | null) — from AI, optional
  - severity (string | null) — from AI, optional
- BudgetMapping (seeded demo data; optional for v1 UI)
  - id, department, contractor, budgetLine, areaPolygon/wardId (simplified schema ok for POC)

6) API design
- GET /api/health
  - Returns service readiness: web, postgres, mailpit, mcp, and timestamp.
- POST /api/reports
  - Content-Type: multipart/form-data
  - Fields: description (string), lat (number), lng (number), photo (image)
  - 201 → { id }
  - Validations: Zod; reject unsupported types and oversized files.
- GET /api/reports
  - Returns list of recent reports for dashboard map; consider minimal pagination.
- Optional: POST /api/reports/:id/actions/notify
  - Triggers email + (optional) tweet simulation; gated by feature flags.

API examples

```bash path=null start=null
# Health
curl -s http://localhost:3000/api/health | jq

# Create a report (example values)
curl -s -X POST http://localhost:3000/api/reports \
  -F description="Pothole near Indiranagar 100ft road" \
  -F lat=12.9716 \
  -F lng=77.5946 \
  -F photo=@/path/to/photo.jpg
```

7) Environment variables (local only; do not commit secrets)

```bash path=null start=null
# .env.local (do not commit)
# Replace placeholders with local values; prefer docker-compose service names/ports.
DATABASE_URL=postgresql://postgres:{{POSTGRES_PASSWORD}}@localhost:5432/infra?schema=public
MAILPIT_HOST=localhost
MAILPIT_SMTP_PORT=1025
MAILPIT_UI_URL=http://localhost:8025
MCP_BASE_URL=http://localhost:{{MCP_PORT}}
FILE_STORAGE_DIR=.data/uploads
# Feature flags
ENABLE_EMAIL=true
ENABLE_CLASSIFICATION=true
SIMULATE_TWITTER=true
```

Notes
- Add .data/ and .env.local to .gitignore (ensure already covered).
- Use placeholders like {{POSTGRES_PASSWORD}} and {{MCP_PORT}}; never hardcode secrets.

8) Local development quickstart

```bash path=null start=null
# 1) Dependencies
pnpm install

# 2) Infra (docker compose)
docker compose up -d postgres mailpit mcp
docker compose ps

# 3) Database (after Prisma schema exists)
pnpm prisma migrate dev

# 4) Dev server
pnpm dev

# 5) Tests
pnpm test
# Optionally E2E (when UI exists)
pnpm exec playwright test
```

9) Testing strategy (TDD-first)
- Unit: Zod validators, small helpers, classification prompt builders.
- Integration: POST /api/reports with multipart handling (file saved, DB row created), notify action with Mailpit stub.
- E2E: Reporter form → backend → Mailpit → dashboard render; mock MCP when credentials absent.
- Tools: Vitest + MSW for API mocks; Playwright for browser E2E; avoid flaky tests.

10) Demo script (5–8 minutes)
1) Show health endpoint: all services green (Postgres/Mailpit/MCP running).
2) Submit a new report with GPS + photo.
3) Show Mailpit UI; open the AI-crafted email.
4) Show dashboard map pin and transparency panel.
5) Optional: show tweet simulation output (or explain fallback).
6) Wrap with key takeaways (local-only, no secrets, TDD, feature flags, sponsor tech used).

11) Risks and fallbacks
- AI classification latency/credentials → fallback to simulated classification.
- Twitter credentials missing → always SIMULATE_TWITTER.
- File storage quotas → cap image size and keep small image count; store under .data/uploads.
- Time constraints → prioritize POST/GET reports and dashboard; social feed can be mocked.

12) Logging and observability
- Use Pino for structured logs (request id, action, status).
- Surface key errors and validation failures; keep logs local and ephemeral.

13) Security & hygiene (local POC)
- No secrets in git; use .env.example and .env.local.
- Sanitize file uploads (type/size); generate safe filenames; no path traversal.
- Validate all inputs with Zod; reject unexpected fields.

14) Timeline (target Oct 2)
- Sep 29 eve: confirm scope, run compose, env scaffolding, health tests.
- Sep 30: Prisma schema + migrations, POST /api/reports with tests, seed budget data.
- Oct 1: Email via Mailpit, MCP classification + tweet simulation, GET /api/reports, E2E happy path.
- Oct 2 AM: Reporter UI + dashboard + transparency panel, polish flags/logging, docs + dry run.

15) Glossary (jargon explained)
- TDD: Write tests first, implement code to pass them.
- Zod: TypeScript-first schema validation library.
- Mailpit: Local SMTP server + web UI for catching emails during development.
- MCP Gateway: Local service exposing tools (like AI models, social posting) via a standard interface; great for local integrations.
- Leaflet: Lightweight JS library to render interactive maps.

16) Decision log (ADR-lite)
- Use Next.js Route Handlers for APIs: colocated, simple DX for POC.
- Local file storage for images: fastest for POC; S3 in production.
- Feature flags for external integrations: avoids demo blockers.
- Strict TS + Zod: fewer runtime surprises, clearer contracts.

17) What’s next
- Implement health checks against Postgres/Mailpit/MCP.
- TDD: POST /api/reports (multipart, file save, DB row) + minimal Prisma schema.
- Add GET /api/reports for dashboard; then wire UI, email, and optional tweet simulation.

18) Interview and production angle
- Interview: Emphasize TDD under time constraints, strict validation, feature-flagged integrations, and local-first reliability.
- Production: Replace local disk with S3, Mailpit with SMTP provider, MCP with hosted APIs, CI/CD, metrics/alerts, secrets management, and hardened file scanning.
